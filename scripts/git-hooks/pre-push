#!/bin/bash

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the current branch
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)

# Get the remote and branch being pushed to
while read local_ref local_sha remote_ref remote_sha
do
  remote_branch=$(echo "$remote_ref" | sed 's/refs\/heads\///')

  # Check if trying to delete main or develop branch
  if [[ "$local_sha" == "0000000000000000000000000000000000000000" ]]; then
    if [[ "$remote_branch" == "main" ]] || [[ "$remote_branch" == "develop" ]]; then
      echo ""
      echo -e "${RED}❌ ERROR: Deletion of '$remote_branch' branch is not allowed!${NC}"
      echo ""
      echo -e "${YELLOW}Protected branches (main, develop) cannot be deleted.${NC}"
      echo "If you need to delete this branch, contact a repository administrator."
      echo ""
      exit 1
    fi
  fi

  # Check if pushing to main or develop directly
  if [[ "$remote_branch" == "main" ]] || [[ "$remote_branch" == "develop" ]]; then
    if [[ "$current_branch" == "$remote_branch" ]]; then
      echo ""
      echo -e "${RED}❌ ERROR: Direct push to '$remote_branch' is not allowed!${NC}"
      echo ""
      echo -e "${YELLOW}Please use the following workflow:${NC}"
      echo "  1. Create a feature branch: git checkout -b feature/your-feature"
      echo "  2. Make your changes and commit"
      echo "  3. Push your feature branch: git push -u origin feature/your-feature"
      echo "  4. Create a Pull Request on GitHub"
      echo ""
      exit 1
    fi
  fi
done

exit 0
