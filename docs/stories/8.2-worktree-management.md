# Story 8.2: Worktree Management

## Goal

Manage git worktrees for the user's project so each content piece gets its own isolated branch. Add PTY directory switching to activate worktrees.

## Dependencies

- Story 8.1 (pipeline types)
- Story 1.3 (terminal PTY)

## Files to Create/Edit

```
src/main/worktree.ts                   # Create: git worktree management
src/main/pty.ts                        # Update: add changePtyDirectory()
```

## Worktree Module (`src/main/worktree.ts`)

Uses `execFile` (NOT `exec`) to avoid shell injection.

### Functions

- `isGitRepo(dir: string): Promise<boolean>` — Runs `git rev-parse --is-inside-work-tree` in the directory.

- `createWorktree(projectRoot: string, branch: string, worktreePath: string): Promise<WorktreeInfo>` — Runs `git worktree add <worktreePath> -b <branch>`. Returns `{ branch, path, contentDir }`.

- `listWorktrees(projectRoot: string): Promise<WorktreeInfo[]>` — Runs `git worktree list --porcelain`, parses output.

- `removeWorktree(projectRoot: string, worktreePath: string): Promise<void>` — Runs `git worktree remove <path>`.

### Worktree Strategy

- Stored at: `<projectRoot>/.content-worktrees/<type>/<date-slug>/`
- Branch naming: `content/<type>/<date-slug>`
- Branched from HEAD of user's project
- If not a git repo: skip silently, no worktree created
- Branch name collision: append numeric suffix `-2`, `-3`

### WorktreeInfo Type (add to types.ts)

```typescript
interface WorktreeInfo {
  branch: string
  path: string          // absolute path to worktree
  contentDir: string    // content/ inside worktree
}
```

## PTY Changes (`src/main/pty.ts`)

Add:
```typescript
export function changePtyDirectory(dir: string) {
  // Cancel partial input, then cd
  ptyProcess?.write(`\x03\ncd ${JSON.stringify(dir)}\n`)
}
```

## Acceptance Criteria

- [ ] isGitRepo correctly detects git repositories
- [ ] createWorktree creates a new git worktree with branch
- [ ] Branch name collisions handled with numeric suffix
- [ ] listWorktrees returns all existing worktrees
- [ ] removeWorktree cleans up worktree
- [ ] changePtyDirectory sends cd command to PTY
- [ ] Non-git repos handled gracefully (no error, just skip)
