# Story 8.1: Pipeline Types + Metadata Backend

## Goal

Define the shared types for the content pipeline and implement the metadata backend that scans for, creates, reads, and updates `metadata.json` files in content directories.

## Dependencies

- Story 2.1 (file watcher / content listing)

## Files to Create/Edit

```
src/shared/types.ts                    # Update: add ContentStage, ContentMetadata, PipelineItem, PipelineAPI
src/main/pipeline.ts                   # Create: metadata I/O, pipeline item listing, content creation
```

## Types to Add

```typescript
// Content pipeline stages
type ContentStage = 'idea' | 'draft' | 'review' | 'final' | 'scheduled' | 'published'

// Metadata stored in each content folder's metadata.json
interface ContentMetadata {
  type: ContentType
  stage: ContentStage
  title: string
  createdAt: string   // ISO 8601
  updatedAt: string   // ISO 8601
  worktreeBranch?: string
  worktreePath?: string
}

// A content piece as displayed in the pipeline sidebar
interface PipelineItem {
  id: string              // unique slug: <type>/<date-slug>
  type: ContentType
  stage: ContentStage
  title: string
  date: string
  metadataPath: string    // absolute path to metadata.json
  contentDir: string      // absolute path to the content folder
  worktreeBranch?: string
  worktreePath?: string
}

// Pipeline API exposed via preload
interface PipelineAPI {
  listPipelineItems: () => Promise<PipelineItem[]>
  createContent: (type: ContentType) => Promise<PipelineItem>
  updateStage: (metadataPath: string, stage: ContentStage) => Promise<void>
  updateMetadata: (metadataPath: string, metadata: Partial<ContentMetadata>) => Promise<void>
  readMetadata: (metadataPath: string) => Promise<ContentMetadata>
  activateContent: (item: PipelineItem) => Promise<void>
  getActiveContent: () => Promise<PipelineItem | null>
  onPipelineChanged: (callback: () => void) => () => void
}
```

Add `pipeline: PipelineAPI` to `ElectronAPI`.

## Pipeline Module (`src/main/pipeline.ts`)

### Functions

- `listPipelineItems(contentDir: string): Promise<PipelineItem[]>` — Recursively scans for `metadata.json` files. Also detects legacy content folders (no metadata.json) and creates PipelineItems with `stage: 'idea'` for backward compatibility. Groups by type, sorts by date descending.

- `createContentPiece(contentDir: string, type: ContentType): Promise<PipelineItem>` — Generates date slug (YYYY-MM-DD), auto-title (e.g., "LinkedIn Post - Feb 21"), creates `content/<type>/<date-slug>/metadata.json`, returns PipelineItem.

- `readMetadata(metadataPath: string): Promise<ContentMetadata>` — Reads and parses metadata.json.

- `writeMetadata(metadataPath: string, updates: Partial<ContentMetadata>): Promise<ContentMetadata>` — Merges updates into existing metadata, updates `updatedAt` timestamp, writes back.

- `updateStage(metadataPath: string, stage: ContentStage): Promise<void>` — Shorthand for updating just the stage field.

### Content Creation Flow

1. Generate date slug from current date
2. Title: `"<Type> Post - <Mon DD>"` (e.g., "LinkedIn Post - Feb 21")
3. Folder: `content/<type>/<YYYY-MM-DD>-<slug>/`
4. Write `metadata.json` with `stage: 'idea'`
5. Return PipelineItem

## Acceptance Criteria

- [ ] New types added to shared/types.ts
- [ ] listPipelineItems scans and returns all content pieces
- [ ] Legacy content (no metadata.json) auto-detected with stage 'idea'
- [ ] createContentPiece creates folder + metadata.json
- [ ] readMetadata / writeMetadata / updateStage work correctly
- [ ] Handles missing files gracefully (returns defaults)
